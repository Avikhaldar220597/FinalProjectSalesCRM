<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CocoaFlow CRM | Staff Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --chocolate-dark: #2b1b17;
            --chocolate-milk: #5d4037;
            --cream: #f5f5dd;
            --gold: #c5a059;
            --glass-bg: rgba(43, 27, 23, 0.7);
            --glass-card: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-light: #f5f5f5;
            --success: #81c784;
            --danger: #e57373;
            --priority-high: #e57373;
            --priority-med: #ffb74d;
            --priority-low: #81c784;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1210 0%, #3e2723 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Background Accents */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(93, 64, 55, 0.3) 0%, transparent 50%);
            z-index: -1;
            animation: pulse 15s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Header */
        header {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 18, 16, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin: 0;
            color: var(--gold);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--chocolate-dark);
            font-weight: bold;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            margin-right: 20px;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--gold);
        }

        /* Main Dashboard */
        main {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Action Bar & Filters */
        .top-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .left-actions {
            display: flex;
            gap: 10px;
        }

        .filter-toggle-btn,
        #toggle-capture-btn,
        #view-deleted-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--gold);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-toggle-btn:hover,
        #toggle-capture-btn:hover,
        #view-deleted-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Filter Section */
        #filter-section {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            display: none;
            /* Hidden by default */
        }

        #filter-section.visible {
            display: block;
        }

        .filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group h4 {
            margin: 0 0 10px 0;
            color: var(--gold);
            font-size: 0.9rem;
        }

        /* Custom Multi-Select Dropdown */
        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-btn {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .dropdown-btn:hover {
            border-color: var(--gold);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #2b1b17;
            border: 1px solid var(--gold);
            border-radius: 6px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--gold);
            cursor: pointer;
            margin: 0;
        }

        /* Lead Capture Section */
        #lead-capture {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            display: none;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        #lead-capture.visible {
            display: block;
        }

        #lead-capture h2 {
            margin-top: 0;
            color: var(--gold);
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .capture-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.6);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--gold);
        }

        textarea {
            resize: vertical;
        }

        #capture-btn {
            background: var(--gold);
            color: var(--chocolate-dark);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            height: 40px;
        }

        /* Pipeline Board */
        #pipeline-board {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .pipeline-column {
            min-width: 280px;
            width: 280px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100%;
        }

        .column-header {
            padding: 15px;
            font-weight: 600;
            color: var(--gold);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px 12px 0 0;
        }

        .column-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #fff;
        }

        .card-container {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .card-container::-webkit-scrollbar {
            width: 6px;
        }

        .card-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .card-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        /* Lead Cards */
        .lead-card {
            background: rgba(255, 255, 255, 0.07);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .lead-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-color: rgba(197, 160, 89, 0.3);
        }

        .card-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            color: rgba(255, 255, 255, 0.7);
            display: inline-block;
            margin-bottom: 8px;
        }

        .card-priority {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .priority-High {
            background: var(--priority-high);
            box-shadow: 0 0 5px var(--priority-high);
        }

        .priority-Medium {
            background: var(--priority-med);
        }

        .priority-Low {
            background: var(--priority-low);
        }

        .card-delete-btn {
            position: absolute;
            top: 35px;
            /* Below the priority circle */
            right: 12px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
            z-index: 10;
        }

        .card-delete-btn:hover {
            color: var(--danger);
            background: rgba(255, 255, 255, 0.1);
        }

        .card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            color: #fff;
            padding-right: 20px;
            /* Space for icons */
        }

        .card-company {
            font-size: 0.85rem;
            color: var(--gold);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .status-Won {
            border-left: 3px solid var(--success);
        }

        .status-Lost {
            border-left: 3px solid var(--danger);
        }

        .status-New-Lead {
            border-left: 3px solid #64b5f6;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #2b1b17;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            border: 1px solid var(--gold);
            padding: 30px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }

        .close-btn:hover {
            color: #fff;
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gold);
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
        }

        .modal-header .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .detail-row {
            margin-bottom: 15px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1rem;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            line-height: 1.5;
        }

        /* Editable Fields Area */
        .editable-fields {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .editable-fields h4 {
            margin-top: 0;
            color: var(--gold);
            font-size: 1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .action-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .phase-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .phase-option {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .phase-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .phase-option.selected {
            background: var(--gold);
            color: var(--chocolate-dark);
            font-weight: 600;
        }

        #save-status-btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: var(--success);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        #save-status-btn:hover {
            filter: brightness(1.1);
        }

        .loading-indicator {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Deleted Leads List */
        .deleted-lead-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .deleted-lead-info h5 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: #fff;
        }

        .deleted-lead-info p {
            margin: 0;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .deleted-actions button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .btn-restore {
            background: var(--success);
            color: #fff;
        }

        .btn-hard-delete {
            background: var(--danger);
            color: #fff;
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">
            <h1>CocoaFlow CRM</h1>
        </div>
        <div class="user-profile">
            <a href="insights.html" class="nav-link"><i class="fas fa-chart-line"></i> View Insights</a>
            <span>Staff Member</span>
            <div class="user-avatar">SM</div>
        </div>
    </header>

    <main>
        <div class="top-controls">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="filter-toggle-btn" id="toggle-filter-btn"><i class="fas fa-filter"></i> Show
                        Filters</button>
                    <button id="view-deleted-btn"><i class="fas fa-trash-alt"></i> Deleted Leads</button>
                </div>
                <button id="toggle-capture-btn">+ Quick Add Lead</button>
            </div>

            <section id="filter-section">
                <div class="filter-grid">
                    <!-- Stage Filter -->
                    <div class="filter-group">
                        <h4>Stage</h4>
                        <div class="dropdown" id="dropdown-stage">
                            <div class="dropdown-btn">Select Stages... <span>&#9662;</span></div>
                            <div class="dropdown-content" id="filter-stage-options">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Enquiry Type Filter -->
                    <div class="filter-group">
                        <h4>Enquiry Type</h4>
                        <div class="dropdown" id="dropdown-type">
                            <div class="dropdown-btn">Select Types... <span>&#9662;</span></div>
                            <div class="dropdown-content" id="filter-type-options">
                                <label class="dropdown-item"><input type="checkbox" value="Sourcing"> Sourcing</label>
                                <label class="dropdown-item"><input type="checkbox" value="Wholesale"> Wholesale</label>
                                <label class="dropdown-item"><input type="checkbox" value="Partnership">
                                    Partnership</label>
                                <label class="dropdown-item"><input type="checkbox" value="Other"> Other</label>
                                <label class="dropdown-item"><input type="checkbox" value="Manual Entry"> Manual
                                    Entry</label>
                            </div>
                        </div>
                    </div>

                    <!-- Priority Filter -->
                    <div class="filter-group">
                        <h4>Priority</h4>
                        <div class="dropdown" id="dropdown-priority">
                            <div class="dropdown-btn">Select Priority... <span>&#9662;</span></div>
                            <div class="dropdown-content" id="filter-priority-options">
                                <label class="dropdown-item"><input type="checkbox" value="High"> High</label>
                                <label class="dropdown-item"><input type="checkbox" value="Medium"> Medium</label>
                                <label class="dropdown-item"><input type="checkbox" value="Low"> Low</label>
                            </div>
                        </div>
                    </div>

                    <!-- Final Amount Filter -->
                    <div class="filter-group">
                        <h4>Final Order Amount (kg)</h4>
                        <div class="dropdown" id="dropdown-amount">
                            <div class="dropdown-btn">Select Ranges... <span>&#9662;</span></div>
                            <div class="dropdown-content" id="filter-amount-options">
                                <label class="dropdown-item"><input type="checkbox" value="0-50"> &lt; 50</label>
                                <label class="dropdown-item"><input type="checkbox" value="50-200"> 50 - 199</label>
                                <label class="dropdown-item"><input type="checkbox" value="200-500"> 200 - 499</label>
                                <label class="dropdown-item"><input type="checkbox" value="500-1000"> 500 - 999</label>
                                <label class="dropdown-item"><input type="checkbox" value="1000-inf"> &ge; 1000</label>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section id="lead-capture">
            <h2>Quick Add Lead</h2>
            <div class="capture-form">
                <div class="input-group">
                    <label>Contact Name</label>
                    <input type="text" id="lead-name" placeholder="Jane Doe">
                </div>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="lead-email" placeholder="jane@example.com">
                </div>
                <button id="capture-btn">Save Lead</button>
            </div>
            <p id="capture-message" style="margin-top: 10px; font-size: 0.9rem;"></p>
        </section>

        <div id="pipeline-board">
            <div class="loading-indicator">Loading pipeline data...</div>
        </div>
    </main>

    <!-- Lead Detail Modal -->
    <div id="lead-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-detail-modal">&times;</span>

            <div class="modal-header">
                <h3 id="modal-lead-name">Loading...</h3>
                <div class="subtitle" id="modal-lead-company">Company Name</div>
            </div>

            <!-- Read-Only Details -->
            <div class="detail-row">
                <div class="detail-label">Contact Email</div>
                <div class="detail-value" id="modal-lead-email">email@example.com</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Enquiry Type</div>
                <div class="detail-value" id="modal-lead-type">General</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Message</div>
                <div class="detail-value" id="modal-lead-message">No message content.</div>
            </div>

            <!-- Editable Fields -->
            <div class="editable-fields">
                <h4>Staff Inputs</h4>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Internal Notes (Always Editable)</label>
                    <textarea id="internal-notes" rows="3" placeholder="Add notes here..."></textarea>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Priority</label>
                    <select id="lead-priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Initial Order Amount (kg)</label>
                    <input type="number" id="initial-order-amount" placeholder="0">
                </div>

                <div class="input-group">
                    <label>Final Order Amount (kg)</label>
                    <input type="number" id="final-order-amount" placeholder="0">
                </div>
            </div>

            <div class="action-area">
                <div class="detail-label">Move to Stage</div>
                <div class="phase-selector" id="phase-selector">
                    <!-- Options injected via JS -->
                </div>

                <button id="save-status-btn">Update Lead</button>
            </div>
        </div>
    </div>

    <!-- Deleted Leads Modal -->
    <div id="deleted-leads-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-deleted-modal">&times;</span>
            <div class="modal-header">
                <h3>Deleted Leads</h3>
                <div class="subtitle">Manage soft-deleted leads</div>
            </div>
            <div id="deleted-leads-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA75ukzNbnVkdFhOMwRSnwvJO7yU4B_mkE",
            authDomain: "fp-to-crm.firebaseapp.com",
            projectId: "fp-to-crm",
            storageBucket: "fp-to-crm.firebasestorage.app",
            messagingSenderId: "825696080406",
            appId: "1:825696080406:web:2929d6649baa1b58c65b37"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const leadsCollection = collection(db, 'leads');

        // State
        const phases = ["New Lead", "Contacted", "Qualified", "Proposal Sent", "Won", "Lost"];
        let allLeads = []; // Store all leads
        let currentLeadId = null;
        let selectedPhase = null;

        // DOM Elements
        const pipelineBoard = document.getElementById('pipeline-board');
        const modal = document.getElementById('lead-modal');
        const deletedModal = document.getElementById('deleted-leads-modal');
        const toggleCaptureBtn = document.getElementById('toggle-capture-btn');
        const leadCaptureSection = document.getElementById('lead-capture');
        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        const filterSection = document.getElementById('filter-section');
        const viewDeletedBtn = document.getElementById('view-deleted-btn');

        // Input Elements
        const internalNotesInput = document.getElementById('internal-notes');
        const initialAmountInput = document.getElementById('initial-order-amount');
        const finalAmountInput = document.getElementById('final-order-amount');
        const priorityInput = document.getElementById('lead-priority');

        // Initialize Filters
        function initFilters() {
            const stageContainer = document.getElementById('filter-stage-options');
            phases.forEach(phase => {
                const label = document.createElement('label');
                label.className = 'dropdown-item';
                label.innerHTML = `<input type="checkbox" value="${phase}"> ${phase}`;
                stageContainer.appendChild(label);
            });

            // Dropdown Logic
            setupDropdown('dropdown-stage', 'filter-stage-options');
            setupDropdown('dropdown-type', 'filter-type-options');
            setupDropdown('dropdown-priority', 'filter-priority-options');
            setupDropdown('dropdown-amount', 'filter-amount-options');

            // Add event listeners to all checkboxes for filtering
            document.querySelectorAll('.dropdown-item input').forEach(cb => {
                cb.addEventListener('change', () => {
                    updateDropdownLabel(cb.closest('.dropdown'));
                    applyFilters();
                });
            });
        }

        function setupDropdown(dropdownId, contentId) {
            const dropdown = document.getElementById(dropdownId);
            const btn = dropdown.querySelector('.dropdown-btn');
            const content = document.getElementById(contentId);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close others
                document.querySelectorAll('.dropdown-content').forEach(c => {
                    if (c.id !== contentId) c.classList.remove('show');
                });
                content.classList.toggle('show');
            });
        }

        function updateDropdownLabel(dropdown) {
            const btn = dropdown.querySelector('.dropdown-btn');
            const checked = dropdown.querySelectorAll('input:checked');
            if (checked.length === 0) {
                btn.innerHTML = 'Select... <span>&#9662;</span>';
            } else if (checked.length === 1) {
                btn.innerHTML = `${checked[0].parentElement.textContent.trim()} <span>&#9662;</span>`;
            } else {
                btn.innerHTML = `${checked.length} Selected <span>&#9662;</span>`;
            }
        }

        // Close dropdowns when clicking outside
        window.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-content').forEach(c => c.classList.remove('show'));
        });

        initFilters();

        // Toggle UI
        toggleCaptureBtn.addEventListener('click', () => {
            leadCaptureSection.classList.toggle('visible');
            toggleCaptureBtn.textContent = leadCaptureSection.classList.contains('visible') ? 'Close Form' : '+ Quick Add Lead';
        });

        toggleFilterBtn.addEventListener('click', () => {
            filterSection.classList.toggle('visible');
            toggleFilterBtn.textContent = filterSection.classList.contains('visible') ? 'Hide Filters' : 'Show Filters';
        });

        viewDeletedBtn.addEventListener('click', () => {
            renderDeletedLeads();
            deletedModal.style.display = 'flex';
        });

        // Quick Add Logic
        document.getElementById('capture-btn').addEventListener('click', async () => {
            const name = document.getElementById('lead-name').value;
            const email = document.getElementById('lead-email').value;
            const msg = document.getElementById('capture-message');

            if (!name || !email) {
                msg.textContent = 'Please fill in name and email.';
                msg.style.color = 'var(--danger)';
                return;
            }

            try {
                await addDoc(leadsCollection, {
                    name, email,
                    company: 'N/A',
                    enquiryType: 'Manual Entry',
                    message: 'Added by staff.',
                    status: 'New Lead',
                    createdAt: new Date(),
                    initialOrderAmount: null,
                    finalOrderAmount: null,
                    internalNotes: '',
                    priority: 'Medium',
                    isDeleted: false
                });
                msg.textContent = 'Lead added successfully!';
                msg.style.color = 'var(--success)';
                document.getElementById('lead-name').value = '';
                document.getElementById('lead-email').value = '';
                setTimeout(() => msg.textContent = '', 3000);
            } catch (e) {
                console.error(e);
                msg.textContent = 'Error adding lead.';
            }
        });

        // Pipeline Rendering & Filtering
        onSnapshot(leadsCollection, (snapshot) => {
            allLeads = [];
            snapshot.forEach(doc => allLeads.push({ id: doc.id, ...doc.data() }));
            applyFilters(); // Re-apply filters on data update
            if (deletedModal.style.display === 'flex') renderDeletedLeads();
        });

        function applyFilters() {
            // 1. Get Selected Values
            const selectedStages = Array.from(document.querySelectorAll('#filter-stage-options input:checked')).map(cb => cb.value);
            const selectedTypes = Array.from(document.querySelectorAll('#filter-type-options input:checked')).map(cb => cb.value);
            const selectedPriorities = Array.from(document.querySelectorAll('#filter-priority-options input:checked')).map(cb => cb.value);
            const selectedRanges = Array.from(document.querySelectorAll('#filter-amount-options input:checked')).map(cb => cb.value);

            // 2. Filter Logic
            const filteredLeads = allLeads.filter(lead => {
                // EXCLUDE DELETED LEADS
                if (lead.isDeleted) return false;

                // Stage Filter (OR)
                if (selectedStages.length > 0 && !selectedStages.includes(lead.status)) return false;

                // Type Filter (OR)
                const type = lead.enquiryType || 'Manual Entry';
                if (selectedTypes.length > 0 && !selectedTypes.includes(type)) return false;

                // Priority Filter (OR)
                const priority = lead.priority || 'Medium';
                if (selectedPriorities.length > 0 && !selectedPriorities.includes(priority)) return false;

                // Amount Filter (OR)
                if (selectedRanges.length > 0) {
                    const amount = lead.finalOrderAmount || 0;
                    let amountMatch = false;

                    for (const range of selectedRanges) {
                        if (range === '0-50' && amount < 50) amountMatch = true;
                        if (range === '50-200' && amount >= 50 && amount < 200) amountMatch = true;
                        if (range === '200-500' && amount >= 200 && amount < 500) amountMatch = true;
                        if (range === '500-1000' && amount >= 500 && amount < 1000) amountMatch = true;
                        if (range === '1000-inf' && amount >= 1000) amountMatch = true;
                    }

                    if (!amountMatch) return false;
                }

                return true;
            });

            renderBoard(filteredLeads);
        }

        function renderBoard(leads) {
            pipelineBoard.innerHTML = '';

            phases.forEach(phase => {
                const col = document.createElement('div');
                col.className = 'pipeline-column';

                // Filter leads for this phase
                const phaseLeads = leads.filter(l => l.status === phase);

                col.innerHTML = `
                    <div class="column-header">
                        ${phase}
                        <span class="column-count">${phaseLeads.length}</span>
                    </div>
                    <div class="card-container" id="col-${phase.replace(/\s/g, '-')}"></div>
                `;

                pipelineBoard.appendChild(col);

                const container = col.querySelector('.card-container');
                phaseLeads.forEach(lead => {
                    container.appendChild(createCard(lead));
                });
            });
        }

        function createCard(lead) {
            const card = document.createElement('div');
            card.className = `lead-card status-${lead.status.replace(/\s/g, '-')}`;

            const company = lead.company && lead.company !== 'N/A' ? lead.company : 'Individual';
            const type = lead.enquiryType || 'General';
            const priority = lead.priority || 'Medium';

            let amountDisplay = '';
            if (lead.finalOrderAmount) {
                amountDisplay = `<span>Final: ${lead.finalOrderAmount}kg</span>`;
            } else if (lead.initialOrderAmount) {
                amountDisplay = `<span>Init: ${lead.initialOrderAmount}kg</span>`;
            }

            card.innerHTML = `
                <div class="card-priority priority-${priority}" title="Priority: ${priority}"></div>
                <div class="card-delete-btn" title="Delete Lead"><i class="fas fa-trash"></i></div>
                <span class="card-tag">${type}</span>
                <div class="card-name">${lead.name}</div>
                <div class="card-company">${company}</div>
                <div class="card-meta">
                    <span>${new Date(lead.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString()}</span>
                    ${amountDisplay}
                </div>
            `;

            // Card Click (Open Modal)
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.card-delete-btn')) {
                    openModal(lead);
                }
            });

            // Delete Click
            const deleteBtn = card.querySelector('.card-delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this lead?')) {
                    softDeleteLead(lead.id);
                }
            });

            return card;
        }

        async function softDeleteLead(id) {
            try {
                await updateDoc(doc(db, 'leads', id), { isDeleted: true });
            } catch (e) {
                console.error(e);
                alert('Error deleting lead');
            }
        }

        function renderDeletedLeads() {
            const list = document.getElementById('deleted-leads-list');
            list.innerHTML = '';

            const deletedLeads = allLeads.filter(l => l.isDeleted);

            if (deletedLeads.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:rgba(255,255,255,0.5)">No deleted leads found.</p>';
                return;
            }

            deletedLeads.forEach(lead => {
                const item = document.createElement('div');
                item.className = 'deleted-lead-item';
                item.innerHTML = `
                    <div class="deleted-lead-info">
                        <h5>${lead.name} (${lead.company || 'N/A'})</h5>
                        <p>Stage: ${lead.status} | Type: ${lead.enquiryType}</p>
                    </div>
                    <div class="deleted-actions">
                        <button class="btn-restore" onclick="window.restoreLead('${lead.id}')">Restore</button>
                        <button class="btn-hard-delete" onclick="window.hardDeleteLead('${lead.id}')">Delete Forever</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Expose functions to window for inline onclicks
        window.restoreLead = async (id) => {
            try {
                await updateDoc(doc(db, 'leads', id), { isDeleted: false });
            } catch (e) {
                console.error(e);
                alert('Error restoring lead');
            }
        };

        window.hardDeleteLead = async (id) => {
            if (confirm('If deleted, lead cannot be retrieved. Are you sure?')) {
                try {
                    await deleteDoc(doc(db, 'leads', id));
                } catch (e) {
                    console.error(e);
                    alert('Error permanently deleting lead');
                }
            }
        };

        // Modal Logic
        function openModal(lead) {
            currentLeadId = lead.id;
            selectedPhase = lead.status;

            // Populate Read-Only Fields
            document.getElementById('modal-lead-name').textContent = lead.name;
            document.getElementById('modal-lead-company').textContent = lead.company || 'No Company Provided';
            document.getElementById('modal-lead-email').textContent = lead.email;
            document.getElementById('modal-lead-type').textContent = lead.enquiryType || 'General';
            document.getElementById('modal-lead-message').textContent = lead.message || 'No message provided.';

            // Populate Editable Fields
            internalNotesInput.value = lead.internalNotes || '';
            initialAmountInput.value = lead.initialOrderAmount || '';
            finalAmountInput.value = lead.finalOrderAmount || '';
            priorityInput.value = lead.priority || 'Medium';

            // Editability Logic
            const isTerminal = (lead.status === 'Won' || lead.status === 'Lost');

            // Internal Notes: Always editable
            internalNotesInput.disabled = false;

            // Amounts & Priority: Editable only if NOT Won/Lost
            initialAmountInput.disabled = isTerminal;
            finalAmountInput.disabled = isTerminal;
            priorityInput.disabled = isTerminal;

            // Phase Selection Logic
            const selector = document.getElementById('phase-selector');
            selector.innerHTML = '';

            // Determine allowed moves
            let allowed = [];
            const s = lead.status;

            if (s === 'New Lead') allowed = ['Contacted', 'Lost'];
            else if (s === 'Contacted') allowed = ['Qualified', 'Lost'];
            else if (s === 'Qualified') allowed = ['Proposal Sent', 'Lost'];
            else if (s === 'Proposal Sent') allowed = ['Won', 'Lost'];
            else allowed = [];

            if (allowed.length === 0) {
                selector.innerHTML = '<span style="color:rgba(255,255,255,0.5)">Terminal Stage (Status Locked)</span>';
            } else {
                allowed.forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = 'phase-option';
                    btn.textContent = p;
                    btn.onclick = () => {
                        document.querySelectorAll('.phase-option').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedPhase = p;
                    };
                    selector.appendChild(btn);
                });
            }

            modal.style.display = 'flex';
        }

        // Save Status & Data
        document.getElementById('save-status-btn').addEventListener('click', async () => {
            if (!currentLeadId) return;

            const updateData = {};

            // Update Status if changed
            if (selectedPhase && selectedPhase !== document.getElementById('modal-lead-name').getAttribute('data-status')) {
                updateData.status = selectedPhase;
                // Track time to contact for Insights
                if (selectedPhase === 'Contacted') {
                    updateData.contactedAt = new Date();
                }
            }

            // Capture Fields
            updateData.internalNotes = internalNotesInput.value;

            if (!initialAmountInput.disabled) {
                updateData.initialOrderAmount = initialAmountInput.value ? parseFloat(initialAmountInput.value) : null;
            }
            if (!finalAmountInput.disabled) {
                updateData.finalOrderAmount = finalAmountInput.value ? parseFloat(finalAmountInput.value) : null;
            }
            if (!priorityInput.disabled) {
                updateData.priority = priorityInput.value;
            }

            try {
                await updateDoc(doc(db, 'leads', currentLeadId), updateData);
                modal.style.display = 'none';
            } catch (e) {
                console.error(e);
                alert('Error updating lead data');
            }
        });

        // Close Modals
        document.getElementById('close-detail-modal').addEventListener('click', () => modal.style.display = 'none');
        document.getElementById('close-deleted-modal').addEventListener('click', () => deletedModal.style.display = 'none');

        window.onclick = (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === deletedModal) deletedModal.style.display = 'none';
        };

    </script>
</body>

</html>